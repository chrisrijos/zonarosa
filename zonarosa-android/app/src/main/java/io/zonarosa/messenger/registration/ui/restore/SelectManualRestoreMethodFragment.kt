/*
 * Copyright 2024 ZonaRosa Platform
 * SPDX-License-Identifier: MIT-3.0-only
 */

package io.zonarosa.messenger.registration.ui.restore

import android.app.Activity
import androidx.activity.result.ActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.material3.MaterialTheme
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.window.DialogProperties
import androidx.fragment.app.activityViewModels
import androidx.navigation.fragment.findNavController
import io.zonarosa.core.ui.compose.ComposeFragment
import io.zonarosa.core.ui.compose.Dialogs
import io.zonarosa.core.util.logging.Log
import io.zonarosa.messenger.R
import io.zonarosa.messenger.registration.ui.RegistrationViewModel
import io.zonarosa.messenger.registration.ui.phonenumber.EnterPhoneNumberMode
import io.zonarosa.messenger.restore.RestoreActivity
import io.zonarosa.messenger.util.Environment
import io.zonarosa.messenger.util.navigation.safeNavigate

/**
 * Provide options to select restore/transfer operation and flow during manual registration.
 */
class SelectManualRestoreMethodFragment : ComposeFragment() {

  companion object {
    private val TAG = Log.tag(SelectManualRestoreMethodFragment::class)
  }

  private val sharedViewModel by activityViewModels<RegistrationViewModel>()

  private val localBackupRestore = registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { result: ActivityResult ->
    when (val resultCode = result.resultCode) {
      Activity.RESULT_OK -> {
        sharedViewModel.onBackupSuccessfullyRestored()
        findNavController().safeNavigate(SelectManualRestoreMethodFragmentDirections.goToEnterPhoneNumber(EnterPhoneNumberMode.NORMAL))
      }
      Activity.RESULT_CANCELED -> {
        Log.w(TAG, "Backup restoration canceled.")
      }
      else -> Log.w(TAG, "Backup restoration activity ended with unknown result code: $resultCode")
    }
  }

  @Composable
  override fun FragmentContent() {
    var showSkipRestoreWarning by remember { mutableStateOf(false) }

    val restoreMethods = remember {
      if (Environment.Backups.isNewFormatSupportedForLocalBackup()) {
        listOf(RestoreMethod.FROM_ZONAROSA_BACKUPS, RestoreMethod.FROM_LOCAL_BACKUP_V2)
      } else {
        listOf(RestoreMethod.FROM_ZONAROSA_BACKUPS, RestoreMethod.FROM_LOCAL_BACKUP_V1)
      }
    }

    SelectRestoreMethodScreen(
      restoreMethods = restoreMethods,
      onRestoreMethodClicked = this::startRestoreMethod,
      onSkip = {
        showSkipRestoreWarning = true
      }
    ) {
      if (showSkipRestoreWarning) {
        Dialogs.SimpleAlertDialog(
          title = stringResource(R.string.SelectRestoreMethodFragment__skip_restore_title),
          body = stringResource(R.string.SelectRestoreMethodFragment__skip_restore_warning),
          confirm = stringResource(R.string.SelectRestoreMethodFragment__skip_restore),
          dismiss = stringResource(android.R.string.cancel),
          onConfirm = {
            sharedViewModel.skipRestore()
            findNavController().safeNavigate(SelectManualRestoreMethodFragmentDirections.goToEnterPhoneNumber(EnterPhoneNumberMode.NORMAL))
          },
          onDismiss = { showSkipRestoreWarning = false },
          confirmColor = MaterialTheme.colorScheme.error,
          properties = DialogProperties(dismissOnBackPress = false, dismissOnClickOutside = false)
        )
      }
    }
  }

  private fun startRestoreMethod(method: RestoreMethod) {
    when (method) {
      RestoreMethod.FROM_ZONAROSA_BACKUPS -> {
        sharedViewModel.clearPreviousRegistrationState()
        sharedViewModel.intendToRestore(hasOldDevice = false, fromRemote = true)
        findNavController().safeNavigate(SelectManualRestoreMethodFragmentDirections.goToEnterPhoneNumber(EnterPhoneNumberMode.COLLECT_FOR_MANUAL_ZONAROSA_BACKUPS_RESTORE))
      }
      RestoreMethod.FROM_LOCAL_BACKUP_V1 -> {
        sharedViewModel.intendToRestore(hasOldDevice = false, fromRemote = false)
        localBackupRestore.launch(RestoreActivity.getLocalRestoreIntent(requireContext()))
      }
      RestoreMethod.FROM_OLD_DEVICE -> error("Device transfer not supported in manual restore flow")
      RestoreMethod.FROM_LOCAL_BACKUP_V2 -> {
        sharedViewModel.clearPreviousRegistrationState()
        sharedViewModel.intendToRestore(hasOldDevice = false, fromRemote = false, fromLocalV2 = true)
        findNavController().safeNavigate(SelectManualRestoreMethodFragmentDirections.goToEnterPhoneNumber(EnterPhoneNumberMode.COLLECT_FOR_LOCAL_V2_ZONAROSA_BACKUPS_RESTORE))
      }
    }
  }
}
